<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Mini WhatsApp â€” HanksGram</title>
<style>
:root{--accent:#25D366;--bg:#e9edef;--me:#dcf8c6;--other:#fff}
*{box-sizing:border-box;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
html,body{margin:0;height:100%;width:100%;background:var(--bg)}
body{display:flex;align-items:stretch;justify-content:center}
.app{width:100%;height:100%;background:#f7f7f8;display:grid;grid-template-columns:320px 1fr;overflow:hidden;box-shadow:0 0 20px rgba(0,0,0,0.12)}
.sidebar{background:#075E54;color:#fff;padding:18px;display:flex;flex-direction:column}
.brand{display:flex;align-items:center;gap:12px;margin-bottom:14px}
.logo{width:46px;height:46px;border-radius:12px;background:var(--accent);display:flex;align-items:center;justify-content:center;font-weight:700;color:#063}
.title{font-size:18px;font-weight:700}
.nameBox{margin-top:8px}
.nameInput,.regionInput{width:100%;padding:8px;border-radius:8px;border:none;margin-top:4px;background:#fff;color:#000}
.users{margin-top:18px;overflow:auto;flex:1}
.userItem{padding:8px 10px;border-radius:8px;background:rgba(255,255,255,0.08);margin-bottom:8px;display:flex;justify-content:space-between;align-items:center}
.statusDot{width:10px;height:10px;border-radius:50%}
.footerSmall{margin-top:auto;font-size:12px;opacity:0.9}
.chatArea{display:flex;flex-direction:column;background:linear-gradient(#f0f0f0,#f7f7f7);height:100%;min-height:0}
.chatHeader{display:flex;align-items:center;gap:12px;padding:8px 12px;border-bottom:1px solid #e0e0e0;flex-shrink:0}
.chatWindow{flex:1;overflow:auto;padding:18px 12px;display:flex;flex-direction:column;justify-content:flex-end;gap:6px;min-height:0}
.msg{max-width:70%;padding:10px 12px;border-radius:16px;word-wrap:break-word;position:relative}
.msg.me{margin-left:auto;background:var(--me);border-bottom-right-radius:2px}
.msg.other{margin-right:auto;background:var(--other);border-bottom-left-radius:2px}
.msg .meta{font-size:11px;margin-top:4px;opacity:0.65;text-align:right}
.composer{display:flex;gap:8px;padding:10px;border-top:1px solid #e8e8e8;background:#fff;flex-shrink:0}
.composer input{flex:1;padding:12px;border-radius:20px;border:1px solid #ddd}
.btn{padding:10px 14px;border-radius:12px;border:none;background:var(--accent);color:#fff;font-weight:700;cursor:pointer}
.small{font-size:12px}
.typing{font-size:12px;opacity:0.8;margin-left:8px}
.overlay{position:fixed;inset:0;background:rgba(0,0,0,0.45);display:flex;align-items:center;justify-content:center;z-index:10}
.modal{background:#fff;padding:20px;border-radius:10px;width:360px;max-width:92%}
.modal h2{margin:0 0 12px 0}
@media (max-width:700px){
  .app{grid-template-columns:1fr;height:100%}
  .sidebar{display:none}
}
</style>
</head>
<body>
<div class="app" role="application">
  <aside class="sidebar">
    <div class="brand">
      <div class="logo">HG</div>
      <div>
        <div class="title">HanksGram</div>
        <div class="small">Realtime Chat</div>
      </div>
    </div>
    <div class="nameBox">
      <label class="small">Your display name</label>
      <input id="nameInput" class="nameInput" disabled>
      <label class="small">Your region</label>
      <input id="regionInput" class="regionInput" disabled>
    </div>
    <div style="margin-top:14px;font-weight:700">Participants</div>
    <div id="users" class="users"></div>
    <div class="footerSmall">Open in multiple tabs/devices to chat.</div>
  </aside>

  <main class="chatArea">
    <div class="chatHeader">
      <div style="font-weight:700">Chat room</div>
      <div id="typing" class="typing"></div>
    </div>
    <div id="chatWindow" class="chatWindow"></div>
    <div class="composer">
      <input id="messageInput" placeholder="Type a message" autocomplete="off">
      <button id="sendBtn" class="btn">Send</button>
    </div>
  </main>
</div>

<div id="modalWrap" class="overlay">
  <div class="modal">
    <h2>Choose your display name and region</h2>
    <p>Enter a name and region to join (change allowed once every 30 days).</p>
    <input id="modalName" placeholder="Your name" style="width:100%;padding:10px;margin-top:8px;border:1px solid #ddd;border-radius:8px">
    <input id="modalRegion" placeholder="Your region" style="width:100%;padding:10px;margin-top:8px;border:1px solid #ddd;border-radius:8px">
    <div style="display:flex;gap:8px;margin-top:12px;justify-content:flex-end">
      <button id="modalJoin" class="btn">Join</button>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
import { getDatabase, ref, push, onChildAdded, set, onValue } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyDfrYQYFBaH5CDECKFDz0dbJdWVGbnPL1I",
  authDomain: "index-641be.firebaseapp.com",
  databaseURL: "https://index-641be-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "index-641be",
  storageBucket: "index-641be.firebasestorage.app",
  messagingSenderId: "622589202823",
  appId: "1:622589202823:web:950bf9af41721e38f60322"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const nameInput = document.getElementById('nameInput');
const regionInput = document.getElementById('regionInput');
const usersDiv = document.getElementById('users');
const chatWindow = document.getElementById('chatWindow');
const messageInput = document.getElementById('messageInput');
const sendBtn = document.getElementById('sendBtn');
const typingDiv = document.getElementById('typing');
const modalWrap = document.getElementById('modalWrap');
const modalName = document.getElementById('modalName');
const modalRegion = document.getElementById('modalRegion');
const modalJoin = document.getElementById('modalJoin');

let displayName = '', region = '', userId = Date.now() + '-' + Math.random().toString(36).slice(2);
let typingTimeout;

// Load saved user
const savedName = localStorage.getItem('displayName');
const savedRegion = localStorage.getItem('region');
const lastChange = parseInt(localStorage.getItem('lastNameChange') || '0');
const thirtyDays = 720 * 60 * 60 * 1000;

if (savedName && savedRegion && Date.now() - lastChange < thirtyDays) {
  displayName = savedName;
  region = savedRegion;
  modalWrap.style.display = 'none';
  nameInput.value = displayName;
  regionInput.value = region;
  registerUser();
} else {
  modalWrap.style.display = 'flex';
}

modalJoin.addEventListener('click', async () => {
  const nameVal = modalName.value.trim();
  const regionVal = modalRegion.value.trim();
  if (!nameVal) return alert('Enter a name');
  
  // Check duplicate name
  const snapshot = await new Promise(resolve => onValue(ref(db, 'users'), resolve, { onlyOnce: true }));
  const data = snapshot.val() || {};
  const duplicate = Object.values(data).some(u => u.name.toLowerCase() === nameVal.toLowerCase());
  if (duplicate) return alert('That name is already taken. Choose another.');

  const now = Date.now();
  localStorage.setItem('displayName', nameVal);
  localStorage.setItem('region', regionVal);
  localStorage.setItem('lastNameChange', now);

  displayName = nameVal;
  region = regionVal;
  nameInput.value = displayName;
  regionInput.value = region;
  modalWrap.style.display = 'none';
  registerUser();
});

// Firebase chat
function sendMessage(text) {
  if (!text.trim()) return;
  push(ref(db, 'messages'), {
    userId, name: displayName, region, text: text.trim(), time: Date.now()
  });
  messageInput.value = '';
  sendTyping(false);
}

onChildAdded(ref(db, 'messages'), (snap) => {
  const m = snap.val();
  renderMessage(m, m.userId === userId);
});

function renderMessage(m, me) {
  if (document.getElementById('msg-' + m.time)) return;
  const wrap = document.createElement('div');
  wrap.id = 'msg-' + m.time;
  wrap.className = 'msg ' + (me ? 'me' : 'other');
  wrap.innerHTML = `<div style="font-weight:700;margin-bottom:6px">${escapeHtml(m.name)}</div>
  <div>${escapeHtml(m.text)}</div>
  <div class="meta">${new Date(m.time).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit',hour12:true})}</div>`;
  chatWindow.appendChild(wrap);
  chatWindow.scrollTop = chatWindow.scrollHeight;
}
function escapeHtml(s){return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');}

// Typing
function sendTyping(isTyping){
  set(ref(db,'typing/'+userId), isTyping?{name:displayName,typing:true}:{name:displayName,typing:false});
}
onValue(ref(db,'typing'), snap=>{
  const data=snap.val()||{};
  const names=Object.values(data).filter(u=>u.typing&&u.name!==displayName).map(u=>u.name);
  typingDiv.textContent=names.length?names.join(', ')+' typing...':'';
});
messageInput.addEventListener('keydown',e=>{
  if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendMessage(messageInput.value);}
  sendTyping(true);clearTimeout(typingTimeout);typingTimeout=setTimeout(()=>sendTyping(false),1200);
});
sendBtn.addEventListener('click',()=>sendMessage(messageInput.value));

// Register + presence
async function registerUser(){
  const userRef=ref(db,'users/'+userId);
  await set(userRef,{name:displayName,region,online:true});
  setupPresence();
  updateParticipants();
}
function setupPresence(){
  const onlineRef=ref(db,'users/'+userId+'/online');
  set(onlineRef,true);
  window.addEventListener('beforeunload',()=>set(onlineRef,false));
  let idleTimeout;
  function resetIdle(){clearTimeout(idleTimeout);set(onlineRef,true);idleTimeout=setTimeout(()=>set(onlineRef,false),60000);}
  document.addEventListener('mousemove',resetIdle);
  document.addEventListener('keydown',resetIdle);
  resetIdle();
}
function updateParticipants(){
  onValue(ref(db,'users'),snap=>{
    const data=snap.val()||{};
    usersDiv.innerHTML='';
    Object.values(data).forEach(u=>{
      const div=document.createElement('div');
      div.className='userItem';
      div.innerHTML=`<span>${escapeHtml(u.name)}</span>`;
      const dot=document.createElement('div');
      dot.className='statusDot';
      dot.style.background=u.online?'limegreen':'grey';
      div.appendChild(dot);
      usersDiv.appendChild(div);
    });
  });
}
</script>
</body>
</html>
